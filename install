#!/bin/bash
set -e

FORGEJO_URL="https://git.bechsor.no"
REPO="jens/clippie"
INSTALL_DIR="${INSTALL_DIR:-$HOME/.local/bin}"

echo "üöÄ Installing Clippie..."

# Create install directory
mkdir -p "$INSTALL_DIR"

# Get latest release info from Forgejo API
echo "üì° Fetching latest release..."
API_URL="$FORGEJO_URL/api/v1/repos/$REPO/releases/latest"
RELEASE_JSON=$(curl -fsSL "$API_URL")

# Extract version
VERSION=$(echo "$RELEASE_JSON" | grep -o '"tag_name":"[^"]*' | cut -d'"' -f4)
if [ -z "$VERSION" ]; then
    echo "‚ùå Could not find latest release"
    exit 1
fi

echo "‚úì Found version: $VERSION"

# Find the aarch64 binary download URL
DOWNLOAD_URL=$(echo "$RELEASE_JSON" | grep -o '"browser_download_url":"[^"]*aarch64[^"]*' | cut -d'"' -f4 | head -1)

if [ -z "$DOWNLOAD_URL" ]; then
    echo "‚ùå Could not find aarch64 binary for this release"
    echo "Available downloads:"
    echo "$RELEASE_JSON" | grep -o '"browser_download_url":"[^"]*' | cut -d'"' -f4 || true
    exit 1
fi

echo "üì• Downloading from: $DOWNLOAD_URL"

# Download and install
TEMP_FILE=$(mktemp)
curl -fsSL -o "$TEMP_FILE" "$DOWNLOAD_URL"
mv "$TEMP_FILE" "$INSTALL_DIR/clippie"
chmod +x "$INSTALL_DIR/clippie"

echo "‚úì Installed to: $INSTALL_DIR/clippie"

# Check if in PATH
if [[ ":$PATH:" != *":$INSTALL_DIR:"* ]]; then
    echo ""
    echo "‚ö†Ô∏è  $INSTALL_DIR is not in your PATH"
    echo "Add this to ~/.zshrc or ~/.bash_profile:"
    echo "  export PATH=\"$INSTALL_DIR:\$PATH\""
    echo ""
    echo "Then run: source ~/.zshrc"
else
    echo "‚úì Already in PATH"
fi

echo ""
echo "üéâ Installation complete!"
echo "Run: clippie"
