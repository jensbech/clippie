#!/bin/bash
# Clear clipboard history entries
set -euo pipefail

# Get DB path from env var, config file, or default
get_db_path() {
    if [[ -n "${CLIPPY_DB_PATH:-}" ]]; then
        echo "$CLIPPY_DB_PATH"
        return
    fi

    local config_file="$HOME/.config/clippy/config.json"
    if [[ -f "$config_file" ]]; then
        # Extract dbPath from JSON config
        local db_path
        db_path=$(grep -o '"dbPath": *"[^"]*"' "$config_file" | cut -d'"' -f4)
        if [[ -n "$db_path" ]]; then
            echo "$db_path"
            return
        fi
    fi

    # Default path
    echo "$HOME/.local/share/clippy/clipboard-history.db"
}

DB_PATH=$(get_db_path)

if [[ ! -f "$DB_PATH" ]]; then
    echo "No clipboard history found." >&2
    exit 0
fi

# Option 1: Clear entire history
if [[ "${1:-}" == "--all" ]]; then
    read -p "Delete ALL clipboard history? (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        sqlite3 "$DB_PATH" "DELETE FROM clipboard_history;"
        sqlite3 "$DB_PATH" "VACUUM;"
        echo "Clipboard history cleared."
    fi
    exit 0
fi

# Option 2: Interactive deletion
entries=$(sqlite3 "$DB_PATH" -separator '|' \
    "SELECT datetime(last_copied, 'unixepoch', 'localtime'), substr(content, 1, 80), id
     FROM clipboard_history
     ORDER BY last_copied DESC;" 2>/dev/null)

if [[ -z "$entries" ]]; then
    echo "No clipboard history found."
    exit 0
fi

# Format and select with fzf (multi-select)
selected=$(echo "$entries" | fzf \
    --multi \
    --ansi \
    --delimiter='|' \
    --with-nth='1,2' \
    --prompt='Select entries to DELETE > ' \
    --header='TAB to select multiple | Enter to delete | Ctrl-C=cancel' \
    --preview "sqlite3 '$DB_PATH' \"SELECT content FROM clipboard_history WHERE id = {3};\"" \
    --preview-window=right:50%:wrap 2>/dev/null)

if [[ -z "$selected" ]]; then
    exit 0
fi

# Extract IDs and delete
ids=$(echo "$selected" | awk -F'|' '{print $3}' | paste -sd ',' -)
deleted_count=$(echo "$selected" | wc -l)
sqlite3 "$DB_PATH" "DELETE FROM clipboard_history WHERE id IN ($ids);"
sqlite3 "$DB_PATH" "VACUUM;"
echo "Deleted $deleted_count entries."
