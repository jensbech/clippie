#!/bin/bash
# Show Clippy daemon status
set -euo pipefail

# Get DB path from env var, config file, or default
get_db_path() {
    if [[ -n "${CLIPPY_DB_PATH:-}" ]]; then
        echo "$CLIPPY_DB_PATH"
        return
    fi

    local config_file="$HOME/.config/clippy/config.json"
    if [[ -f "$config_file" ]]; then
        # Extract dbPath from JSON config
        local db_path
        db_path=$(grep -o '"dbPath": *"[^"]*"' "$config_file" | cut -d'"' -f4)
        if [[ -n "$db_path" ]]; then
            echo "$db_path"
            return
        fi
    fi

    # Default path
    echo "$HOME/.local/share/clippy/clipboard-history.db"
}

echo "Clippy Daemon Status"
echo "===================="
echo

# Check if loaded
if launchctl list 2>/dev/null | grep -q clippy-daemon; then
    echo "Status: Running ✓"

    # Get PID
    pid=$(launchctl list 2>/dev/null | grep clippy-daemon | awk '{print $1}')
    echo "PID: $pid"

    # Check database
    db_path=$(get_db_path)
    if [[ -f "$db_path" ]]; then
        count=$(sqlite3 "$db_path" "SELECT COUNT(*) FROM clipboard_history;" 2>/dev/null || echo "0")
        size=$(du -h "$db_path" | awk '{print $1}')
        echo "Database: $count entries ($size)"
    else
        echo "Database: Not initialized"
    fi

    # Show recent log
    echo
    echo "Recent log entries:"
    if [[ -f "$HOME/Library/Logs/clippy-daemon.err.log" ]]; then
        tail -5 "$HOME/Library/Logs/clippy-daemon.err.log"
    fi
else
    echo "Status: Not running ✗"
fi
