#!/bin/bash
# Background daemon to monitor clipboard changes
set -euo pipefail

# Get DB path from env var, config file, or default
get_db_path() {
    if [[ -n "${CLIPPY_DB_PATH:-}" ]]; then
        echo "$CLIPPY_DB_PATH"
        return
    fi

    local config_file="$HOME/.config/clippy/config.json"
    if [[ -f "$config_file" ]]; then
        # Extract dbPath from JSON config
        local db_path
        db_path=$(grep -o '"dbPath": *"[^"]*"' "$config_file" | cut -d'"' -f4)
        if [[ -n "$db_path" ]]; then
            echo "$db_path"
            return
        fi
    fi

    # Default path
    echo "$HOME/.local/share/clippy/clipboard-history.db"
}

DB_PATH=$(get_db_path)
POLL_INTERVAL=1

# Initialize database
init_db() {
    local db_dir
    db_dir=$(dirname "$DB_PATH")
    mkdir -p "$db_dir"
    sqlite3 "$DB_PATH" <<'SQL'
CREATE TABLE IF NOT EXISTS clipboard_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    content TEXT NOT NULL,
    content_hash TEXT NOT NULL UNIQUE,
    first_copied INTEGER NOT NULL,
    last_copied INTEGER NOT NULL,
    copy_count INTEGER DEFAULT 1
);
CREATE INDEX IF NOT EXISTS idx_content_hash ON clipboard_history(content_hash);
CREATE INDEX IF NOT EXISTS idx_last_copied ON clipboard_history(last_copied DESC);
SQL
    chmod 600 "$DB_PATH"
}

# Main monitoring loop
monitor() {
    local last_hash=""
    local current_hash=""
    local current_content=""
    local change_time=0
    local stability_window=2  # seconds

    while true; do
        # Get current clipboard content
        local content
        if ! content=$(pbpaste 2>/dev/null); then
            sleep "$POLL_INTERVAL"
            continue
        fi

        # Skip empty or whitespace-only clipboard
        if ! echo "$content" | grep -q '[^[:space:]]'; then
            sleep "$POLL_INTERVAL"
            continue
        fi

        # Calculate hash
        local hash
        hash=$(echo -n "$content" | shasum -a 256 | awk '{print $1}')

        # Check if content changed
        if [[ "$hash" != "$current_hash" ]]; then
            # Content changed, start stability timer
            current_hash="$hash"
            current_content="$content"
            change_time=$(date +%s)
        else
            # Content unchanged, check if stable long enough to record
            local now
            now=$(date +%s)
            if [[ $((now - change_time)) -ge $stability_window ]] && [[ "$current_hash" != "$last_hash" ]]; then
                # Content is stable and different from last recorded
                local escaped_content
                escaped_content=$(echo "$current_content" | sed "s/'/''/g")

                if sqlite3 "$DB_PATH" <<SQL 2>/dev/null
INSERT INTO clipboard_history (content, content_hash, first_copied, last_copied, copy_count)
VALUES ('$escaped_content', '$current_hash', $now, $now, 1)
ON CONFLICT(content_hash) DO UPDATE SET
    last_copied = $now,
    copy_count = copy_count + 1;
SQL
                then
                    last_hash="$current_hash"
                else
                    echo "ERROR: Database insert failed for hash $current_hash" >&2
                fi
            fi
        fi

        sleep "$POLL_INTERVAL"
    done
}

# Main
init_db
monitor
