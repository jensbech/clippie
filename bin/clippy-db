#!/bin/bash
# Swap or create clipboard databases

set -euo pipefail

CONFIG_FILE="$HOME/.config/clippy/config.json"

# Show help
if [[ $# -eq 0 ]] || [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
  echo "Usage: clippy-db <path>"
  echo ""
  echo "Swap to an existing database or create a new one."
  echo ""
  echo "Examples:"
  echo "  clippy-db ~/.local/share/clippy/clipboard-history.db  # Use existing or create"
  echo "  clippy-db /tmp/test.db                                 # Create new at /tmp/test.db"
  exit 0
fi

DB_PATH="$1"

# Expand ~ to home directory
DB_PATH="${DB_PATH/#\~/$HOME}"

# Ensure it's an absolute path
if [[ ! "$DB_PATH" = /* ]]; then
  echo "Error: Database path must be absolute" >&2
  exit 1
fi

DB_DIR=$(dirname "$DB_PATH")

# Create directory if needed
if ! mkdir -p "$DB_DIR" 2>/dev/null; then
  echo "Error: Cannot create directory: $DB_DIR" >&2
  exit 1
fi

# Create database if it doesn't exist
if [[ ! -f "$DB_PATH" ]]; then
  echo "Creating new database: $DB_PATH"
  if ! sqlite3 "$DB_PATH" <<'SQL' 2>/dev/null; then
CREATE TABLE IF NOT EXISTS clipboard_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    content TEXT NOT NULL,
    content_hash TEXT NOT NULL UNIQUE,
    first_copied INTEGER NOT NULL,
    last_copied INTEGER NOT NULL,
    copy_count INTEGER DEFAULT 1
);
CREATE INDEX IF NOT EXISTS idx_content_hash ON clipboard_history(content_hash);
CREATE INDEX IF NOT EXISTS idx_last_copied ON clipboard_history(last_copied DESC);
SQL
    echo "Error: Failed to create database" >&2
    exit 1
  fi
  chmod 600 "$DB_PATH"
else
  echo "Using existing database: $DB_PATH"
fi

# Update config
echo "Updating configuration..."
mkdir -p "$(dirname "$CONFIG_FILE")"

# Use jq if available, otherwise use sed
if command -v jq &> /dev/null; then
  jq ".dbPath = \"$DB_PATH\"" "$CONFIG_FILE" > "$CONFIG_FILE.tmp"
  mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
else
  # Fallback for systems without jq
  sed -i.bak "s|\"dbPath\": \"[^\"]*\"|\"dbPath\": \"$DB_PATH\"|" "$CONFIG_FILE"
  rm -f "$CONFIG_FILE.bak"
fi

echo "✓ Database swapped to: $DB_PATH"

# Restart daemon if running
if launchctl list 2>/dev/null | grep -q clippy-daemon; then
  echo "Restarting daemon..."
  launchctl stop clippy-daemon 2>/dev/null || true
  sleep 1
  launchctl start clippy-daemon
  echo "✓ Daemon restarted"
else
  echo "Daemon not running. Start with: clippy-start"
fi
